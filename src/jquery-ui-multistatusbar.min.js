/*
 * Copyright 2013 Marc CARRE
 * https://github.com/marccarre/jquery-multi-status-bar
 * Licensed under the Apache License, Version 2.0.
 */
(function(d){function h(a){this.table=d("<table width='"+a+"px' cellpadding='0' cellspacing='0'></table>");this.table.addClass("ui-widget").addClass("ui-state-default").addClass("ui-corner-all").addClass("ui-multistatusbar");this.tr=d("<tr></tr>");this.table.append(this.tr);this.addValue=function(b,a,c){b=d("<td style='background-color: "+c+"; width:"+a+"px;'>"+b+"</td>");this.tr.append(b);return b}}function m(){this.div=d("<div></div>");this.div.addClass("ui-widget").addClass("ui-state-default").addClass("ui-corner-all").addClass("ui-multistatusbar-legend"); this.table=d("<table></table>");this.div.append(this.table);this.div.hide();this.addCategory=function(a,b){this.table.append("<tr><td><div class='ui-multistatusbar-legend-icon' style='background-color: "+b+";'></div></td><td>"+a+"</td></tr>")}}d.widget("ui-marccarre.multistatusbar",{version:"1.1.0",options:{width:200,payload:{},urls:{},colors:[],showLegend:!0,showValuesInLegend:!1,showValuesInBar:!0,refreshUrl:null,refreshFrequencyInMillis:5E3,enableRefresh:!0},_create:function(){this._doCreate(); null!=this.options.refreshUrl&&this._setUpAutoRefresh()},_doCreate:function(){var a;a=this.options.payload;var b=0,e;for(e in a)b+=a[e];a=b;0==a?this._createEmptyWidget():this._createAndPopulateWidget(a)},_createEmptyWidget:function(){var a=new h(this.options.width);a.addValue("N/A",this.options.width,"#DDDDDD");this.element.append(a.table)},_createAndPopulateWidget:function(a){var b=this.options.width/a,e=new h(this.options.width);this.element.append(e.table);if(this.options.showLegend){var c=new m; this.element.append(c.div);e.table.mouseover(function(){c.div.show()});e.table.mouseleave(function(){c.div.hide()})}var n=this.options.colors,d=this.options.payload,j=this.options.urls,k=0,f;for(f in d){var g=d[f],l=n[k];if(0<g){var p=e.addValue(this.options.showValuesInBar?g:"&nbsp;",g*b,l);f in j&&p.wrapInner('<a href="'+j[f]+'" target="_blank" ></a>')}this.options.showLegend&&c.addCategory(this.options.showValuesInLegend?f+": "+g+"/"+a:f,l);k++}},_setUpAutoRefresh:function(){function a(b){function e(){var a= document.domain.toString();if(!(a=0<a.length&&0<c.length&&-1!==c.indexOf(a)))a=window.location.hostname.toString(),a=0<a.length&&0<c.length&&-1!==c.indexOf(a)||"http://host:port/webservice/status"===c;return a}var c=b.options.refreshUrl;b.options.enableRefresh&&d.ajax({url:c,dataType:e()?"json":"jsonp"}).done(function(a){b.options.payload=e()?a:JSON.parse(a)}).fail(function(a,c,d){console.log("error: "+JSON.stringify(a)+"\n status: "+c+"\n error: "+d);b.options.payload={}}).always(function(){b.element.children().remove(); b._doCreate();setTimeout(function(){a(b)},b.options.refreshFrequencyInMillis)})}a(this)},_destroy:function(){this.options.enableRefresh=!1;this.element.children().remove()}})})(jQuery);